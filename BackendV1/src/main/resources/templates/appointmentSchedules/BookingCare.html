<!doctype html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/indexxx}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <title>Document</title>
</head>

<body layout:fragment="content">
<section class="vh-100" style="margin-top: 100px ">

  <p class="h1 text-center mt-3 mb-4 pb-3 text-primary">
    <i class="fas fa-check-square me-1"></i>
    <u>Booking care</u>
  </p>
  <form class="row g-3 needs-validation" novalidate
        style="width: 50%; margin: auto;border-radius: 10px; padding: 20px; box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;"
        th:object="${user}">

    <div class="col-md-4">
      <label for="name" class="form-label" >Full name</label>

      <input type="hidden" class="form-control"  th:value="${user.id}" name ="user_id">
      <input type="text" class="form-control" id="name" value="Mark" th:field="*{name}" required>
      <div class="valid-feedback">
        Looks good!
      </div>
    </div>
    <div class="col-md-4">
      <label for="validationCustom02" class="form-label">Number phone</label>
      <input type="number" class="form-control" id="validationCustom02" value="Otto" required th:field="*{phone}">
      <div class="valid-feedback">
        Looks good!
      </div>
    </div>
    <div class="col-md-4">
      <label for="userEmail" class="form-label" >Email</label>
      <div class="input-group has-validation">
        <input type="text" class="form-control" id="userEmail" aria-describedby="inputGroupPrepend"
               th:field="*{email}" th:value="*{email}" required>
        <div class="invalid-feedback">
          Please choose a username.
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <label for="timeBook" class="form-label">Date time</label>
      <input type="datetime-local" class="form-control"  required name="time" id="timeBook">
      <div class="invalid-feedback">
        Please provide a valid timer
      </div>
    </div>

    <div class="col-md-3">
      <label for="addressName" class="form-label">Address</label>
      <select class="form-select" id="addressName" required onchange="addressChanged(this)" >
        <option selected disabled value="" >--Chose Address--</option>
        <div th:each="fality:${falities}">
          <option th:text="${fality.address}">...</option>
        </div>
      </select>
      <div class="invalid-feedback">
        Please select a valid state.
      </div>
    </div>
    <div class="col-md-3">
      <label for="facilityName" class="form-label">Facility</label>
      <select class="form-select" id="facilityName" required>
        <option selected disabled value="" >--Facility Name --</option>
      </select>
      <div class="invalid-feedback">
        Please select a valid state.
      </div>
    </div>
    <div class="col-md-3">
      <label for="doctorName" class="form-label" >Doctor</label>
      <select class="form-select" id="doctorName" required name="doctor_name">
        <option selected disabled value=""></option>
      </select>
      <div class="invalid-feedback">
        Please select a valid state.
      </div>
    </div>


    <div class="col-12">
      <div style="display: flex; justify-content: space-between">

        <button class="btn btn-primary" type="button" onclick="saveBookCare(),postscheduleEmail()">Submit form</button>
      </div>

    </div>

  </form>
</section>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<script type="text/javascript">


  function addressChanged(obj) {
    var htmlContent = ""
    var value = obj.value;
    var api = "/api/facility/address/" + value
    var id = obj.id;
    fetch(api)
            .then((response) => response.json())
            .then((data) => console.log(data),

                    $.ajax({
                      method: "GET",
                      url: "/api/facility/address/" + value,
                      type:"json",
                      success: function (reponse){
                        for (let i = 0 ; i<reponse.length ; i++){
                          htmlContent += "<option value="+reponse[i].id+">"+reponse[i].name+"</option>";
                          facilityChanged(reponse[0].name)
                          $('#facilityName').html(htmlContent)

                        }

                      },error: function (err){
                        alert("false")
                      }
                    })
            )
  }

  function facilityChanged(obj) {
    console.log(obj)
    var htmlContent = ""
    var value = obj;
    console.log(value)
    var api = "/api/doctor/facility/"+value

    fetch(api)
            .then((response) => response.json())
            .then((data) => console.log(data),
                    $.ajax({
                      method: "GET",
                      url: "/api/doctor/facility/"+value,
                      type:"json",
                      success: function (reponse){
                        for (let i = 0 ; i<reponse.length ; i++){
                          htmlContent += "<option value="+reponse[i].id+">"+reponse[i].name+"</option>";
                          $('#doctorName').html(htmlContent)
                        }

                      },error: function (err){
                        alert("false")
                      }
                    })
            )
  }

  // api/v1/appointment/save
  function  saveBookCare(){
    var formData = {
      user:{
        id: $("input[name=user_id]").val()
      },
      doctor:{
        id:$("#doctorName").val()
      },
      time: $("#timeBook").val(),
      status:{
        id:1,
      }
    }

    $.ajax({
      method: "POST",
      url: "/api/v1/appointment/save",
      type:"json",
      contentType:"application/json",
      data:JSON.stringify(formData),
      success: function (reponse){
        window.location.href = "/Appointment/user/" + formData.user.id;
      },error: function (err){
        alert("false")
      }
    })
  }
  function postscheduleEmail(){
    // var email = "Duclvth2108005@fpt.edu.vn"
    var email = $("#ema")
    var name = $('#name').val()
    var doctor = $('#doctorName').val()
    var facility = $('#facilityName').val()
    var dateTime =$("#timeBook").val()
    // var dateTime = time.getH5ours() - 5;
    var subject = "Appointment Notify!"
    var body = "Hello "+name+" you have an appointment scheduled for today at: "+dateTime+" with Dr : "+doctor
            +" at : "+facility+"."
    var data = {
      "email": email,
      "dateTime": dateTime,
      "subject": subject,
      "body":body,
      "timeZone":"Asia/Ho_Chi_Minh"
    }
    $.ajax({
      url: "/scheduleEmail",
      type: "POST",
      dataType: "json",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function (response) {
        // alert("success save book");
      },
      error: function (err) {
        alert(err)
      }
    })
  }

</script>
</body>

</html>